@{
        ViewBag.Title = "부킹 등록";
        var AppointmentDate = ViewBag.Mode == "update" ? Model.AppointmentDate.ToString("yyyy-MM-dd") : DateTime.Now.ToString("yyyy-MM-dd");
        var BookingDate = ViewBag.Mode == "update" ? Model.BookingDate.ToString("yyyy-MM-dd") : "";
}
@model Booking.Models.BookingOrder
<div class="content">

    <form name="form" method="post" action="/Booking/BookingWrite">
        <input type="hidden" name="OrderId" id="no" value="@Model.OrderId">
        <input type="hidden" name="mode" id="mode" value="@ViewBag.Mode">
        <!-- Menu Title -->
        <ul class="list-group menu-title">
            <li class="list-group-item list-group-item-info">부킹 등록</li>
            <li class="list-group-item list-group-item-warning color-red menu-title-help">
                <i class='fa fa-custom astrick'>*</i> 표시는 필수입니다.
            </li>
        </ul>					<!--//Menu Title -->

        <div class="col-xs-12">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th><i class='fa fa-custom astrick'>*</i>접수일</th>
                            <th><i class='fa fa-custom astrick'>*</i>매니져</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" name="AppointmentDate" class="calendar_max_icon only_date date only_philsu" value='@AppointmentDate' readonly></td>
                            <td>
                                <select name="UserId" class="manager_id only_focus only_philsu">
                                    <option value="@(((Booking.Utilities.CustomUser.CustomPrincipal)User).UserId)" selected>@Context.User.Identity.Name</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-xs-12">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <tbody>
                        <tr class="form_body">
                            <th width="10%" class="ws-normal">라운딩 예약일<i class='fa fa-custom astrick'>*</i></th>
                            <td class="text-left">
                                <input type="hidden" name=BookingDate value="@Model.BookingDate"/>
                                <input type="text" id="booking_date" class="only_date calendar_icon only_focus booking_date only_philsu" value='@BookingDate'>
                                <select id="booking_hour" class="booking_hour only_focus only_philsu">
                                    <option value="" selected>시</option>
                                    <option value='4'>04시</option>
                                    <option value='5'>05시</option>
                                    <option value='6'>06시</option>
                                    <option value='7'>07시</option>
                                    <option value='8'>08시</option>
                                    <option value='9'>09시</option>
                                    <option value='10'>10시</option>
                                    <option value='11'>11시</option>
                                    <option value='12'>12시</option>
                                    <option value='13'>13시</option>
                                    <option value='14'>14시</option>
                                    <option value='15'>15시</option>
                                    <option value='16'>16시</option>
                                    <option value='17'>17시</option>
                                    <option value='18'>18시</option>
                                    <option value='19'>19시</option>
                                    <option value='20'>20시</option>
                                </select>
                                <select id="booking_bun" class="booking_bun only_focus only_philsu">
                                    <option value="" selected>분</option>
                                    <option value='0'>00분</option>
                                    <option value='1'>01분</option>
                                    <option value='2'>02분</option>
                                    <option value='3'>03분</option>
                                    <option value='4'>04분</option>
                                    <option value='5'>05분</option>
                                    <option value='6'>06분</option>
                                    <option value='7'>07분</option>
                                    <option value='8'>08분</option>
                                    <option value='9'>09분</option>
                                    <option value='10'>10분</option>
                                    <option value='11'>11분</option>
                                    <option value='12'>12분</option>
                                    <option value='13'>13분</option>
                                    <option value='14'>14분</option>
                                    <option value='15'>15분</option>
                                    <option value='16'>16분</option>
                                    <option value='17'>17분</option>
                                    <option value='18'>18분</option>
                                    <option value='19'>19분</option>
                                    <option value='20'>20분</option>
                                    <option value='21'>21분</option>
                                    <option value='22'>22분</option>
                                    <option value='23'>23분</option>
                                    <option value='24'>24분</option>
                                    <option value='25'>25분</option>
                                    <option value='26'>26분</option>
                                    <option value='27'>27분</option>
                                    <option value='28'>28분</option>
                                    <option value='29'>29분</option>
                                    <option value='30'>30분</option>
                                    <option value='31'>31분</option>
                                    <option value='32'>32분</option>
                                    <option value='33'>33분</option>
                                    <option value='34'>34분</option>
                                    <option value='35'>35분</option>
                                    <option value='36'>36분</option>
                                    <option value='37'>37분</option>
                                    <option value='38'>38분</option>
                                    <option value='39'>39분</option>
                                    <option value='40'>40분</option>
                                    <option value='41'>41분</option>
                                    <option value='42'>42분</option>
                                    <option value='43'>43분</option>
                                    <option value='44'>44분</option>
                                    <option value='45'>45분</option>
                                    <option value='46'>46분</option>
                                    <option value='47'>47분</option>
                                    <option value='48'>48분</option>
                                    <option value='49'>49분</option>
                                    <option value='50'>50분</option>
                                    <option value='51'>51분</option>
                                    <option value='52'>52분</option>
                                    <option value='53'>53분</option>
                                    <option value='54'>54분</option>
                                    <option value='55'>55분</option>
                                    <option value='56'>56분</option>
                                    <option value='57'>57분</option>
                                    <option value='58'>58분</option>
                                    <option value='59'>59분</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>골프장</th>
                            <td>
                                <table class="table-in-2">
                                    <tbody>
                                        <tr>
                                            <th width="8%">골프장 <i class='fa fa-custom astrick'>*</i></th>
                                            <td width="*">
                                                <select name="CourseId" class="golf_place only_focus only_philsu" style="width:98% !important;">
                                                    <option value=''></option>
                                                    @foreach (var item in ViewBag.Place)
                                                    {
                                                    <option value='@item.CourseId'>@item.CourseName</option>
                                                    }
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>인원</th>
                                            <td>
                                                <select name="MemberNumber" class="people_num only_focus only_philsu" style="width:60px !important;">
                                                    <option value='4'>4명</option>
                                                    <option value='3'>3명</option>
                                                    <option value='2'>2명</option>
                                                    <option value='1'>1명</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <th>예약자<i class='fa fa-custom astrick'>*</i></th>
                            <td class="text-left">
                                이름:<input type="text" name="BookingUserName" class="customer only_focus  only_delete_space only_philsu" value="@Model.BookingUserName" maxlength="20">
                                연락처:<input type="text" name="Phone" class="customer_mobile only_mobile only_focus only_philsu" value="@Model.Phone" maxlength="15">
                            </td>
                        </tr>
                        <tr>
                            <th class="ws-normal">그린피</th>
                            <td>
                                <table class="table-in-2">
                                    <thead>
                                        <tr>
                                            <th colspan="3">인당</th>
                                            <th rowspan="2"><span class="people_num_remark">4</span>명 합계</th>
                                        </tr>
                                        <tr>
                                            <th>현장</th>
                                            <th>선입</th>
                                            <th><i class='fa fa-custom astrick'>*</i>합계</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-center"><input type="text" name="PayBalance" class="pay_field text-right only_focus only_auto_comma" value="@Model.PayBalance" style="width:70px !important"></td>
                                            <td class="text-center"><input type="text" name="Deposit" class="pay_first text-right only_focus only_auto_comma" value="@Model.Deposit" style="width:70px !important"></td>
                                            <td class="text-center"><input type="text" name="SubTotal" class="pay_sub text-right only_auto_comma only_philsu" value="@Model.SubTotal" readonly style="width:70px !important"></td>
                                            <td class="text-center"><input type="text" name="Total" class="pay_sub_total text-right only_auto_comma only_philsu" value="@Model.Total" readonly style="width:70px !important"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <th>수수료</th>
                            <td>


                                <table class="table-in-2">
                                    <thead>
                                        <tr>
                                            <th>인당</th>
                                            <th><span class="people_num_remark">4</span>명 합계</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-center">
                                                <input type="text" name="Commission" class="manager_commission text-right only_auto_comma" value="@Model.Commission" readonly>
                                            </td>
                                            <td class="text-center"><input type="text" name="TotalCommission" class="manager_commission_total text-right only_auto_comma" value="@Model.TotalCommission" readonly></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <th>비고사항</th>
                            <td><input type="text" name="Description" class="remark only_focus" value="@Model.Description" maxlength="100" style="width:100%;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div><!--//.col-xs-12-->

        <div class="col-xs-12">
            <!--Button Group -->
            <div class="btn-group-inline">
                <div class="form-group button-group">
                    &nbsp;
                    @if (ViewBag.Mode == "write")
                    {
                        <button type='button' class='btn btn-xs btn-success' name='button_write' id='button_insert'><i class='fa fa-check'></i> 등록</button>
                    }
                    @if (ViewBag.Mode == "update")
                    {
                        <button type='button' class='btn btn-xs btn-success' name='button_update' id='button_update'><i class='fa fa-check'></i> 수정</button>
                    }
                    &nbsp;&nbsp;<button type='button' class='btn btn-xs btn-warning' name='button_back' id='button_back'><i class='fa fa-step-backward'></i> 뒤로</button>&nbsp;
                </div>
            </div>
            <!--//Button Group -->
        </div><!--//.col-xs-12-->

    </form>
</div><!--//.content-->


@section Scripts {
    <style type="text/css">
		form {max-width:60%; margin:0 auto;}
		select {width:auto !important;}
		input[type=text] {width:100% important;}

		.table > thead > tr > th {padding:3px;}
		.table > tbody > tr > th {padding:3px; text-align:left;}
		.table > tbody > tr > td {padding:3px;}

		.table-in-2 > tbody > tr > th {padding:3px; text-align:left;}
		.table-in-2 > tbody > tr > td {padding:1px; text-align:left;}
    </style>

    <script type="text/javascript">
		re_gong = /\s+/g;	//공백제거

		$(window).load(function(){
			var mode=$("form #mode").val();
			$("form .only_focus").eq(0).focus();
		});

		$(function(){
			$("form .only_focus").removeClass('ime-eng ime-eng-only').addClass('ime-kor');
			var mode=$("form #mode").val();
			if (mode == 'update') {
			    $("#booking_hour").val("@Model.BookingDate.Hour");
			    $("#booking_bun").val("@Model.BookingDate.Minute");
			    $("select[name=CourseId]").val("@Model.CourseId");
			    $("select[name=MemberNumber]").val("@Model.MemberNumber");
			    $('.people_num_remark').text("@Model.MemberNumber");
			}
			/* jquery 플러그인 select박스 검색 */
			$(".golf_place").select2({
				language: "ko",
				placeholder: "골프장 선택",	/* 직접하고 싶다면 data-placeholder='xXXX' */
				//tags: "true",				/* 일치되지 않아도 입력가능 */
				allowClear: true
			});

			//예약일이 접수일보다 큰지 체크
			$('.booking_date').on('change blur', function (){
				var i =0;
				//alert(i);
				loadData_check_booking_date(i);
			});

			//골프장 수수료구하기
			$('.golf_place').on({
			    change: function () {
					$.ajax({
						type:'POST',
						url: '/booking/getcommission',
						data : {
						    courseid: $(this).val()
						},
						success: function (r) {
						    $('input[name=Commission]').autoNumeric('set', r.Data.Commission);
						    var manager_commission = parseInt($('.manager_commission').autoNumeric('get'), 10); if (!manager_commission) manager_commission = 0;
						    var people_num = parseInt($('.people_num').val(), 10); if (!people_num) people_num = 1;
						    $('.manager_commission_total').autoNumeric('set', manager_commission * people_num);
						}
					});
				}
			});

			//그린피 결제합계 구하기
			$('.pay_field,.pay_first').on({
				change:function(){
					var i =0;
					var pay_field=parseInt($('.pay_field').eq(i).autoNumeric('get'),10);	if(!pay_field) pay_field=0;
					var pay_first=parseInt($('.pay_first').eq(i).autoNumeric('get'),10);	if(!pay_first) pay_first=0;
					$('.pay_sub').eq(i).autoNumeric('set',pay_field+pay_first);

					get_pay_sub_total(i); //총인원합계구하기
				}
			});
			//인원변경시 구하기
			$('.people_num').on({
				change:function(){
					var i =0;
					get_pay_sub_total(i); //총인원합계구하기
				}
			});


			$('form #button_insert').click(function(){
			    //check_customer_mobile();	/* 연락처 검사 후 등록 */
			    var bookingdate = $("#booking_date").val() + " "+$("#booking_hour").val() +":"+ $("#booking_bun").val();
			    $("input[name=BookingDate]").val(bookingdate);
				write_question('');
			});	//등록버튼
			$('form #button_update').click(function(){
			    //check_customer_mobile();	/* 연락처 검사 */
			    var bookingdate = $("#booking_date").val() + " " + $("#booking_hour").val() + ":" + $("#booking_bun").val();
			    $("input[name=BookingDate]").val(bookingdate);
				write_question('');
			});	//수정버튼
			$('form #button_back').click(function(){	history.go(-1);	});	//삭제버튼
		});
		//해당인원에 대한 총합계구하기.
		function get_pay_sub_total(i){
			var pay_sub=parseInt($('.pay_sub').eq(i).autoNumeric('get'),10);	if(!pay_sub) pay_sub=0;
			var manager_commission=parseInt($('.manager_commission').eq(i).autoNumeric('get'),10);	if(!manager_commission) manager_commission=0;
			var people_num=parseInt($('.people_num').eq(i).val(),10);	if(!people_num) people_num=1;

			$('.people_num_remark').text(people_num); //몇명 표시

			$('.pay_sub_total').eq(i).autoNumeric('set',pay_sub*people_num);
			$('.manager_commission_total').eq(i).autoNumeric('set',manager_commission*people_num);



		}
		/* 예약일 검사 */
		function loadData_check_booking_date(i){
			var date=$('.date').val();
			var booking_date = $('.booking_date').eq(i).val().replace(re_gong, "");
			if (booking_date && date > booking_date)
			{
			    alert("예약일은 접수일 보다 커야합니다");
			    return false;
			}
		}

		/* 예약자 연락처 검사   예약일이 토.일 이거나 8시 이전엔 경우. */
		function check_customer_mobile(){
			var message = true;

			//$(".philsu_message").each(function(index){	//모든 philsu_message 조사
				//var philsu_message=$(this).text();		//현재 each값
				//if(philsu_message=='OK'){
					var index=0;
					var booking_date=$('.booking_date').eq(index).val();
					var customer_mobile=$('.customer_mobile').eq(index).val();
					var booking_hour=parseInt($('.booking_hour').eq(index).val(),10);	if(!booking_hour) booking_hour=0;
					if(booking_date && booking_hour){
						var yoil=common_get_yoil(booking_date);
						if((yoil=='토' || yoil=='일' || booking_hour < 8 ) && !customer_mobile){
							alert('오전 8시 이전 혹은 토.일인 경우\n예약자 연락처는 필수입니다.');
							$('.customer_mobile').eq(index).focus();
							message =false;
							return false;
						}
					}
				//}
			//});

			if(message){
				write_question('');	/*입력 및 수정*/
			}
		}
    </script>

}


